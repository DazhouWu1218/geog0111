


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../images/ucl.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.12">
    
    
      
        <title>3.2 Accessing MODIS Data products - GEOG0111</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4dd2dd8d.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#32-accessing-modis-data-products" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="GEOG0111" class="md-header-nav__button md-logo" aria-label="GEOG0111">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            GEOG0111
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              3.2 Accessing MODIS Data products
            
          </span>
        </div>
      
    </div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GEOG0111" class="md-nav__button md-logo" aria-label="GEOG0111">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    GEOG0111
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Course Basics
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Course Basics" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Course Basics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../001_Notebook_use/" title="Notebook Use" class="md-nav__link">
      Notebook Use
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../002_Unix/" title="Unix" class="md-nav__link">
      Unix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../003_Help/" title="Help" class="md-nav__link">
      Help
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../004_Accounts/" title="Accounts" class="md-nav__link">
      Accounts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-5" type="checkbox" id="nav-1-5">
    
    <label class="md-nav__link" for="nav-1-5">
      Answers
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Answers" data-md-level="2">
      <label class="md-nav__title" for="nav-1-5">
        <span class="md-nav__icon md-icon"></span>
        Answers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../001_Notebook_use_answers/" title="Notebook Use" class="md-nav__link">
      Notebook Use
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../002_Unix_answers/" title="Unix" class="md-nav__link">
      Unix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../003_Help_answers/" title="Help" class="md-nav__link">
      Help
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#321-introduction" class="md-nav__link">
    3.2.1 Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#322-accessing-nasa-modis-urls" class="md-nav__link">
    3.2.2  Accessing NASA MODIS URLs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3221-datetime" class="md-nav__link">
    3.2.2.1 datetime
  </a>
  
    <nav class="md-nav" aria-label="3.2.2.1 datetime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3222-html" class="md-nav__link">
    3.2.2.2 html
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#323-modis-filename-format" class="md-nav__link">
    3.2.3 MODIS filename format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#324-saving-binary-data-to-a-file" class="md-nav__link">
    3.2.4 Saving binary data to a file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#324-downloading-the-data-file" class="md-nav__link">
    3.2.4 downloading the data file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#325-visualisation" class="md-nav__link">
    3.2.5 Visualisation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#326-summary" class="md-nav__link">
    3.2.6 Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="32-accessing-modis-data-products">3.2 Accessing MODIS Data products</h1>
<h1>Table of Contents<span class="tocSkip"></span></h1>

<div class="toc"><ul class="toc-item"><li><span><a href="#3.2-Accessing-MODIS-Data-products" data-toc-modified-id="3.2-Accessing-MODIS-Data-products-1">3.2 Accessing MODIS Data products</a></span><ul class="toc-item"><li><span><a href="#3.2.1-Introduction" data-toc-modified-id="3.2.1-Introduction-1.1">3.2.1 Introduction</a></span></li><li><span><a href="#3.2.2--Accessing-NASA-MODIS-URLs" data-toc-modified-id="3.2.2--Accessing-NASA-MODIS-URLs-1.2">3.2.2  Accessing NASA MODIS URLs</a></span></li><li><span><a href="#3.2.2.1-datetime" data-toc-modified-id="3.2.2.1-datetime-1.3">3.2.2.1 <code>datetime</code></a></span><ul class="toc-item"><li><span><a href="#3.2.2.2-html" data-toc-modified-id="3.2.2.2-html-1.3.1">3.2.2.2 html</a></span></li></ul></li><li><span><a href="#3.2.3-MODIS-filename-format" data-toc-modified-id="3.2.3-MODIS-filename-format-1.4">3.2.3 MODIS filename format</a></span></li><li><span><a href="#3.2.4-Saving-binary-data-to-a-file" data-toc-modified-id="3.2.4-Saving-binary-data-to-a-file-1.5">3.2.4 Saving binary data to a file</a></span></li><li><span><a href="#3.2.4-downloading-the-data-file" data-toc-modified-id="3.2.4-downloading-the-data-file-1.6">3.2.4 downloading the data file</a></span></li><li><span><a href="#3.2.5-Visualisation" data-toc-modified-id="3.2.5-Visualisation-1.7">3.2.5 Visualisation</a></span></li><li><span><a href="#3.2.6-Summary" data-toc-modified-id="3.2.6-Summary-1.8">3.2.6 Summary</a></span></li></ul></li></ul></div>

<h2 id="321-introduction">3.2.1 Introduction</h2>
<p>In this section, you will learn how to:</p>
<ul>
<li>scan the directories (on the Earthdata server) where the MODIS data are stored</li>
<li>get the dataset filename for a given tile, date and product</li>
<li>get to URL associated with the dataset</li>
<li>use the URL to pull the dataset over to store in the local file system</li>
</ul>
<p>You should already know:</p>
<ul>
<li>basic use of Python (sections 1 and 2)</li>
<li>the MODIS product grid system</li>
<li>
<p>the two tiles needed to cover the UK </p>
<pre><code>tiles = ['h17v03', 'h18v03']
</code></pre>
</li>
<li>
<p>what LAI is and the code for the MODIS LAI/FPAR product <a href="https://modis.gsfc.nasa.gov/data/dataprod/mod15.php">MOD15</a></p>
</li>
<li>your username and password for <a href="https://urs.earthdata.nasa.gov/home">NASA Earthdata</a>, or have previously entered this with <a href="../geog0111/cylog.py"><code>cylog</code></a>.</li>
</ul>
<p>Let's first just test your NASA login:</p>
<pre><code class="python">import geog0111.nasa_requests as nasa_requests
from geog0111.cylog import cylog

url = 'https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/' 

# grab the HTML information
try:
    html = nasa_requests.get(url).text
    # test a few lines of the html
    if html[:20] == '&lt;!DOCTYPE HTML PUBLI':
        print('this seems to be ok ... ')
        print('use cylog().login() anywhere you need to specify the tuple (username,password)')
except:
    print('login error ... try entering your username password again')
    print('then re-run this cell until it works')
    cylog(init=True)
</code></pre>

<pre><code>this seems to be ok ... 
use cylog().login() anywhere you need to specify the tuple (username,password)
</code></pre>
<p>We use the local class <code>geog0111.nrequests</code> here, in place of the usual <code>requests</code> as this lets the user avoid exposure to some of the tricky bits of getting data from the NASA server.</p>
<h2 id="322-accessing-nasa-modis-urls">3.2.2  Accessing NASA MODIS URLs</h2>
<p>Although you can access MODIS datasets through the <a href="https://urs.earthdata.nasa.gov/home">NASA Earthdata</a> interface, there are many occasions that we would want to just automatically pull datasets. This is particularly true when you want a time series of data that might involve many files. For example, for analysing LAI or other variables over space/time) we will want to write code that pulls the time series of data. </p>
<p>This is also something you will need to do the your assessed practical.</p>
<p>If the data we want to use are accessible to us as a URL, we can simply use <code>requests</code> as in previous exercises.</p>
<p>Sometimes, we will be able to specify the parameters of the dataset we want, e.g. using <a href="https://www.json.org">JSON</a>. At othertimes (as in the case here) we might need to do a little work ourselves to construct the particular URL we want.</p>
<p>If you visit the site <a href="https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006">https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006</a>, you will see 'date' style links (e.g. <code>2018.09.30</code>) through to sub-directories. </p>
<p>In these, e.g. <a href="https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/">https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/</a> you will find URLs of a set of files. </p>
<p>The files pointed to by the URLs are the MODIS MOD15 4-day composite 500 m LAI/FPAR product <a href="https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mcd15a3h_v006">MCD15A3H</a>.</p>
<p>There are links to several datasets on the page, including 'quicklook files' that are jpeg format images of the datasets, e.g.:</p>
<p><img alt="MCD15A3H.A2018273.h17v03" src="https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/BROWSE.MCD15A3H.A2018273.h17v03.006.2018278143630.1.jpg" /></p>
<p>as well as <code>xml</code> files and <code>hdf</code> datasets. </p>
<h2 id="3221-datetime">3.2.2.1 <code>datetime</code></h2>
<p>The URL we have used above, <a href="https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/">https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/</a> starts with a call to the server directory <code>MOTA</code>, so we can think of <code>https://e4ftl01.cr.usgs.gov/MOTA</code> asd the base level URL.</p>
<p>The rest of the directoy information <code>MCD15A3H.006/2018.09.30</code> tells us:</p>
<ul>
<li>the product name <code>MCD15A3H</code></li>
<li>the product version <code>006</code></li>
<li>the date of the dataset <code>2018.09.30</code></li>
</ul>
<p>There are several ways we could specify the date information. The most 'human readable' is probably <code>YYYY.MM.DD</code> as given here. </p>
<p>Sometimes we will want to refer to it by 'day of year' (<code>doy</code>) (sometimes mistakenly referred to as <a href="https://en.wikipedia.org/wiki/Julian_day">Julian day</a>) for a particular year. Day of year will be an integer that goes from 1 to 365 or 366 (inclusive).</p>
<p>We can use the Python <code>datetime</code> to do this:</p>
<p>import datetime</p>
<p>year = 2018</p>
<p>for doy in [1,60,365,366]:
    # set it up as Jan 1st, plus doy - 1
    d = datetime.datetime(year,1,1) + datetime.timedelta(doy-1)</p>
<pre><code># note the careful formatting to include zeros in datestr
datestr = f'{d.year:4d}.{d.month:02d}.{d.day:02d}'

print(f'doy {doy:3d} in {year} is {datestr}')
</code></pre>
<p><strong>Exercise 3.2.1</strong></p>
<ul>
<li>copy the above code, and change the year to a leap year to see if it works as expected</li>
<li>write some code that loops over each day in the year and converts from <code>doy</code> to the format of <code>datestr</code> above.</li>
<li>modify the code so that it forms the full directory URL for the MODIS dataset, e.g. <code>https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/</code> for each <code>doy</code></li>
<li>use what you have learned to write a function called <code>get_url()</code>, which you give the year and day of year and which returns the full URL. It should use keywords to define <code>product</code>, <code>version</code> and <code>base_url</code>. </li>
<li>For homework, tidy up your function, making sure you document it properly. Think aboiut what might happen if you enter incorrect information.</li>
</ul>
<p><strong>Hint</strong>: </p>
<ol>
<li>
<p>number of days in year</p>
<p>ndays_in_year = (datetime.datetime(year,12,31) - datetime.datetime(year,1,1)).days + 1</p>
</li>
</ol>
<p>Remember that <code>doy</code> goes from 1 to 365 or 366 (inclusive).</p>
<ol>
<li><code>datestr</code> format</li>
</ol>
<p>We use <code>datestr = f'{d.year:4d}.{d.month:02d}.{d.day:02d}'</code> as the date string format. The elements such as <code>{d.year:4d}</code> mean that <code>d.year</code> is interpreted as an integer (<code>d</code>) of length <code>4</code>. When we put a <code>0</code> in front, such as in <code>02d</code> the resultant string is 'padded' with <code>0</code>. Try something like:</p>
<pre><code>value = 10
print(f'{value:X10f}')
</code></pre>
<ol>
<li>some bigger hints ...</li>
</ol>
<p>To get the full URL, you will probably want to define something along the lines of:</p>
<pre><code>url = f'{base_url}/{product}.{version:03d}/{datestr}'
</code></pre>
<p>assuming version is an integer.</p>
<pre><code class="python"># do exercise here
</code></pre>

<h3 id="3222-html">3.2.2.2 html</h3>
<p>When we access this 'listing' (directory links such as <a href="https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/">https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/</a>) from Python, we will obtain the information in <a href="https://www.w3schools.com/html/">HTML</a>. We don't expect you to know this language in any great depth, but knowing some of the basics is oftem useful.</p>
<pre><code class="python">import geog0111.nasa_requests as nasa_requests
from geog0111.get_url import get_url
import datetime

doy,year = 273,2018
# use your get_url function
# or the one supplied in geog0111
url = get_url(doy,year).url
print(url)

# pull the html
html = nasa_requests.get(url).text

# print a few lines of the html
print(html[:951])
# etc
print('\n','-'*30,'etc','-'*30)
# at the end
print(html[-964:])
</code></pre>

<pre><code>https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Index of /MOTA/MCD15A3H.006/2018.09.30&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
&lt;script src="https://status.earthdata.nasa.gov/assets/banner_widget.js"&gt;&lt;/script&gt;
&lt;!-- Add the Status banner --&gt;
&lt;div id="earthdata-notification-banner"&gt;&lt;/div&gt;
&lt;!-- End Status banner --&gt;
&lt;pre&gt;
********************************************************************************

                         U.S. GOVERNMENT COMPUTER

This is the NASA Land Processes Distributed Active Archive Center (LP DAAC) 
Distribution Server hosted at the USGS Earth Resources Observation and Science 
(EROS) Center.  The purpose of this server is to provide NASA data products to 
the public.  The directory listing is exposed intentionally for user navigation 
to the NASA data products.  Large data downloads (not jpeg browse) requires 
user authentication through the NASA Earthdata Login. To obtain a NASA Earthdata 
Logi

 ------------------------------ etc ------------------------------

&lt;img src="/icons/unknown.gif" alt="[   ]"&gt; &lt;a href="MCD15A3H.A2018273.h35v08.006.2018278143649.hdf.xml"&gt;MCD15A3H.A2018273.h35v08.006.2018278143649.hdf.xml&lt;/a&gt;      2018-10-05 09:42  7.6K  
&lt;img src="/icons/unknown.gif" alt="[   ]"&gt; &lt;a href="MCD15A3H.A2018273.h35v09.006.2018278143649.hdf"&gt;MCD15A3H.A2018273.h35v09.006.2018278143649.hdf&lt;/a&gt;          2018-10-05 09:42  207K  
&lt;img src="/icons/unknown.gif" alt="[   ]"&gt; &lt;a href="MCD15A3H.A2018273.h35v09.006.2018278143649.hdf.xml"&gt;MCD15A3H.A2018273.h35v09.006.2018278143649.hdf.xml&lt;/a&gt;      2018-10-05 09:42  7.6K  
&lt;img src="/icons/unknown.gif" alt="[   ]"&gt; &lt;a href="MCD15A3H.A2018273.h35v10.006.2018278143650.hdf"&gt;MCD15A3H.A2018273.h35v10.006.2018278143650.hdf&lt;/a&gt;          2018-10-05 09:42  298K  
&lt;img src="/icons/unknown.gif" alt="[   ]"&gt; &lt;a href="MCD15A3H.A2018273.h35v10.006.2018278143650.hdf.xml"&gt;MCD15A3H.A2018273.h35v10.006.2018278143650.hdf.xml&lt;/a&gt;      2018-10-05 09:42  7.6K  
&lt;hr&gt;&lt;/pre&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre>
<p>In HTML the code text such as: </p>
<pre><code>&lt;a href="MCD15A3H.A2018273.h35v10.006.2018278143650.hdf"&gt;MCD15A3H.A2018273.h35v10.006.2018278143650.hdf&lt;/a&gt;
</code></pre>
<p>specifies an HTML link, that will appear as </p>
<pre><code>MCD15A3H.A2018273.h35v10.006.2018278143650.hdf 2018-10-05 09:42  7.6K
</code></pre>
<p>and link to the URL specified in the <code>href</code> field: <code>MCD15A3H.A2018273.h35v10.006.2018278143650.hdf</code>.</p>
<p>We could interpret this information by searching for strings etc., but the package <code>BeautifulSoup</code> can help us a lot in this.</p>
<pre><code class="python">import geog0111.nasa_requests as nasa_requests
from geog0111.get_url import get_url
from bs4 import BeautifulSoup

doy,year = 273,2018
url = get_url(doy,year).url
html = nasa_requests.get(url).text

# use BeautifulSoup
# to get all urls referenced with
# html code &lt;a href=&quot;some_url&quot;&gt;
soup = BeautifulSoup(html,'lxml')
links = [mylink.attrs['href'] for mylink in soup.find_all('a')]
</code></pre>

<p><strong>Exercise E3.2.2</strong></p>
<ul>
<li>copy the code in the block above and print out some of the linformation in the list <code>links</code> (e.g. the last 20 entries)</li>
<li>using an implicit loop, make a list called <code>hdf_filenames</code> of only those filenames (links) that have <code>hdf</code> as their filename extension.</li>
</ul>
<p><strong>Hint 1</strong>: first you might select an example item from the <code>links</code> list: </p>
<pre><code>item = links[-1]
print('item is',item)
</code></pre>
<p>and print:</p>
<pre><code>item[-3:]
</code></pre>
<p>but maybe better (why would this be?) is:</p>
<pre><code>item.split('.')[-1]
</code></pre>
<p><strong>Hint 2</strong>: An implicit loop is a construct of the form:</p>
<pre><code>[item for item in links]
</code></pre>
<p>In an implicit for loop, we can actually add a conditional statement if we like, e.g. try:</p>
<pre><code>hdf_filenames = [item for item in links if item[-5] == '4']
</code></pre>
<p>This will print out <code>item</code> if the condition <code>item[-5] == '4'</code> is met. That's a bit of a pointless test, but illustrates the pattern required. Try this now with the condition you want to use to select <code>hdf</code> files.</p>
<pre><code class="python"># do exercise here
</code></pre>

<h2 id="323-modis-filename-format">3.2.3 MODIS filename format</h2>
<p>The <code>hdf</code> filenames are of the form:</p>
<pre><code>MCD15A3H.A2018273.h35v10.006.2018278143650.hdf
</code></pre>
<p>where:</p>
<ul>
<li>the first field (<code>MCD15A3H</code>) gives the product code</li>
<li>the second (<code>A2018273</code>) gives the observation date: day of year <code>273</code>, <code>2018</code> here</li>
<li>the third (<code>h35v10</code>) gives the 'MODIS tile' code for the data location</li>
<li>the remaining fields specify the product version number (<code>006</code>) and a code representing the processing date.</li>
</ul>
<p>If we want a particular dataset, we would assume then that we know the information to construct the first four fields.</p>
<p>We then have the task remaining of finding an address of the pattern:</p>
<pre><code>MCD15A3H.A2018273.h17v03.006.*.hdf
</code></pre>
<p>where <code>*</code> represents a wildcard (unknown element of the URL/filename).</p>
<p>Putting together the code from above to get a list of the <code>hdf</code> files:</p>
<pre><code class="python">#from geog0111.nasa_requests import nasa_requests
from bs4 import BeautifulSoup
from geog0111.get_url import get_url
import geog0111.nasa_requests as nasa_requests

doy,year = 273,2018
url = get_url(doy,year).url
html = nasa_requests.get(url).text
soup = BeautifulSoup(html,'lxml')
links = [mylink.attrs['href'] for mylink in soup.find_all('a')]

# get all files that end 'hdf' as in example above
hdf_filenames = [item for item in links if item.split('.')[-1] == 'hdf']
</code></pre>

<p>We now want to specify a particular tile or tiles to access.</p>
<p>In this case, we want to look at the field <code>item.split('.')[-4]</code> and check to see if it is the list <code>tiles</code>.</p>
<p><strong>Exercise 3.2.3</strong></p>
<ul>
<li>copy the code above and print out the first 10 values in the list <code>hdf_filenames</code>. Can you recognise where the tile information is in the string?</li>
</ul>
<p>Now, let's check what we get when we look at <code>item.split('.')[-4]</code>.</p>
<ul>
<li>set a variable called <code>tiles</code> containing the names of the UK tiles (as in Exercise 3.1.1)</li>
<li>write a loop <code>for item in links:</code> to loop over each item in the list <code>links</code></li>
<li>inside this loop set the condition <code>if item.split('.')[-1] == 'hdf':</code> to select only <code>hdf</code> files, as above</li>
<li>inside this conditional statement, print out <code>item.split('.')[-4]</code> to see if it looks like the tile names</li>
<li>having confirmed that you are getting the right information, add another conditional statement to see if <code>item.split('.')[-4] in tiles</code>, and then print only those filenames that pass both of your tests</li>
<li>see if you can combine the two tests (the two <code>if</code> statements) into a single one</li>
</ul>
<p><strong>Hint 1</strong>: if you print all of the tilenames, this will go on for quite some time. Instead it may be better to use <code>print(item.split('.')[-4],end=' ')</code>, which will put a space, rather than a newline between each item printed.</p>
<p><strong>Hint 2</strong>: recall what the logical statement <code>(A and B)</code> gives when thinking about the combined <code>if</code> statement</p>
<pre><code class="python"># do exercise here
</code></pre>

<p>You should end up with something like:</p>
<pre><code class="python">import geog0111.nasa_requests as nasa_requests
from bs4 import BeautifulSoup
from geog0111.get_url import get_url

doy,year = 273,2018
tiles = ['h17v03', 'h18v03']

url = get_url(doy,year).url
html = nasa_requests.get(url).text
soup = BeautifulSoup(html,'lxml')
links = [mylink.attrs['href'] for mylink in soup.find_all('a')]

tile_filenames = [item for item in links \
                      if (item.split('.')[-1] == 'hdf') and \
                         (item.split('.')[-4] in tiles)]
</code></pre>

<p><strong>Exercise E3.2.4</strong></p>
<ul>
<li>print out the first 10 items in <code>tile_filenames</code> and check the result is as you expect.</li>
<li>write a function called <code>modis_tiles()</code> that takes as input <code>doy</code>, <code>year</code> and <code>tiles</code> and returns a list of the modis tile <strong>urls</strong>.</li>
</ul>
<p><strong>Hint</strong> </p>
<ol>
<li>
<p>Don't forget to put in a mechanism to allow you to change the default <code>base_url</code>, <code>product</code> and <code>version</code> (as you did for the function <code>get_url()</code>)</p>
</li>
<li>
<p>In some circumstances, yopu can get repeats of filenames in the list. One way to get around this is to convert the list to a <code>numpy</code> array, and use <a href="https://docs.scipy.org/doc/numpy-1.15.0/reference/generated/numpy.unique.html"><code>np.unique()</code></a> to remove duplicates.</p>
<pre><code>import numpy as np
tile_filenames = np.unique(tile_filenames)
</code></pre>
</li>
</ol>
<pre><code class="python"># do exercise here
</code></pre>

<p>You should end up with something like:</p>
<pre><code class="python">from geog0111.modis_tiles import modis_tiles

doy,year = 273,2018
tiles = ['h17v03', 'h18v03']

tile_urls = modis_tiles(doy,year,tiles)
</code></pre>

<p><strong>Exercise E3.2.5</strong></p>
<ul>
<li>print out the first 10 items in <code>tile_urls</code> and check the result is as you expect.</li>
</ul>
<pre><code class="python"># do exercise here
</code></pre>

<h2 id="324-saving-binary-data-to-a-file">3.2.4 Saving binary data to a file</h2>
<p>We suppose that we want to save the dataset to a local file on the system.</p>
<p>To do that, we need to know how to save a binary dataset to a file. To do this well, we should also consider factors such as whether we want to save a file we already have. </p>
<p>Before we go any further we should check:</p>
<ul>
<li>that the directory exists (if not, create it)</li>
<li>that the file doesn't already exist (else, don't bother)</li>
</ul>
<p>We can conveniently use methods in <a href="https://docs.python.org/3/library/pathlib.html"><code>pathlib.Path</code></a> for this.</p>
<p>So, import <code>Path</code>:</p>
<pre><code>from pathlib import Path
</code></pre>
<p>We suppose we might want to put a file (variable <code>filename</code>) into the directory <code>destination_folder</code>:</p>
<p>To test if a directory exists and create if not:</p>
<pre><code>dest_path = Path(destination_folder)
if not dest_path.exists():
    dest_path.mkdir()
</code></pre>
<p>To make a compound name of <code>dest_path</code> and <code>filename</code>:</p>
<pre><code>output_fname = dest_path.joinpath(filename)
</code></pre>
<p>To test if a file exists:</p>
<pre><code>if not output_fname.exists():
    print(f"{str(output_fname))} doesn't exist yet ..."})
</code></pre>
<p><strong>Exercise E3.2.6</strong></p>
<ul>
<li>set a variable <code>destination_folder</code> to <code>data</code> and write code to create this folder ('directory') if it doesn't already exist.</li>
<li>set a variable <code>filename</code> to <code>test.bin</code> and write code to check to see if this file is in the folder <code>destination_folder</code>. If not, print a message to say so.</li>
</ul>
<pre><code class="python"># do exercise here
</code></pre>

<p>We now try to read the binary file <code>data/test_image.bin</code>.</p>
<p>This involves opening a binary file for reading:</p>
<pre><code>fp = open(input_fname, 'rb')
</code></pre>
<p>Then reading the data:</p>
<pre><code>data = fp.read()
</code></pre>
<p>Then close <code>fp</code></p>
<pre><code>fp.close()
</code></pre>
<pre><code class="python">input_fname = 'data/test_image.bin'
fp = open(input_fname, 'rb')
data = fp.read()
fp.close()
print(f'data read is {len(data)} bytes')
</code></pre>

<pre><code>data read is 9136806 bytes
</code></pre>
<p>And now, write the data as <code>data/test.bin</code>.</p>
<p>This involves opening a binary file for writing:</p>
<pre><code>fp = open(output_fname, 'wb')
</code></pre>
<p>Then reading the data:</p>
<pre><code>d = fp.write(data)
</code></pre>
<p>and closing as before:</p>
<pre><code>fp.close()
</code></pre>
<pre><code class="python">output_fname = 'data/test.bin'
fp = open(output_fname, 'wb')
d = fp.write(data)
print(f'data written is {d} bytes')
</code></pre>

<pre><code>data written is 9136806 bytes
</code></pre>
<p>We can avoid the need for the <code>close</code> by using the construct:</p>
<pre><code>with open(output_fname, 'wb') as fp:
    d = fp.write(data)
</code></pre>
<pre><code class="python">d = 0
with open(output_fname, 'wb') as fp:
    d = fp.write(data)
print(f'data written is {d} bytes')
</code></pre>

<pre><code>data written is 9136806 bytes
</code></pre>
<p><strong>Exercise E3.2.7</strong></p>
<p>With the ideas above, write some code to:</p>
<ul>
<li>check to see if the output directory <code>data</code> exists</li>
<li>if not, create it</li>
<li>check to see if the input file <code>data/test_image.bin</code> exists</li>
<li>if so, read it in to <code>data</code></li>
<li>check to see if the output file <code>data/test.bin</code> exists</li>
<li>if not (and if you read data), save <code>data</code> to this file</li>
<li>once you are happy with the code operation, write a function: <code>save_data(data,filename,destination_folder)</code> that takes the binary dataset <code>data</code> and writes it to the file <code>filename</code> in directory <code>destination_folder</code>. It should return the n umber of bytes written, and should check to see if files / directories exist and act accordingly.</li>
<li>add a keyword option to <code>save_data()</code> that will overwrite the filename, even if it already exists.</li>
</ul>
<pre><code class="python"># do exercise here
</code></pre>

<p>You should now know how to save a binary data file.</p>
<h2 id="324-downloading-the-data-file">3.2.4 downloading the data file</h2>
<p>The following code uses the <code>nasa_requests</code> library to pull some binary data from a URL.</p>
<p>The response is tested (<code>r.ok</code>), and if it is ok, then we split the url to derive the filename, and print this out.</p>
<p>The binary dataset is available as <code>r.content</code>, which we store to the variable <code>data</code> here:</p>
<pre><code class="python">import geog0111.nasa_requests as nasa_requests
from geog0111.modis_tiles import modis_tiles
from pathlib import Path

doy,year = 273,2018
tiles = ['h17v03', 'h18v03']
destination_folder = 'data'

tile_urls = modis_tiles(doy,year,tiles)

# loop over urls
for url in tile_urls:
    r = nasa_requests.get(url)

    # check response
    if r.ok:
        # get the filename from the url
        filename = url.split('/')[-1]
        # get the binary data
        data = r.content

        print(filename)
    else:
        print (f'response from {url} not good')
</code></pre>

<pre><code>response from https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/MCD15A3H.A2018273.h17v03.006.2018278143630.hdf not good
response from https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/MCD15A3H.A2018273.h18v03.006.2018278143633.hdf not good
</code></pre>
<p><strong>Exercise E3.2.8</strong></p>
<ul>
<li>use the code above to write a function <code>get_modis_files()</code> that takes as input <code>doy</code>, <code>year</code> and <code>tiles</code>, has a default <code>destination_folder</code> of <code>data</code>, that downloads the appropriate datasets (if they don't already exist). It should have similar defaults to <code>modis_tiles()</code>. It should return a list of the output filenames.</li>
</ul>
<pre><code class="python"># do exercise here
</code></pre>

<p>You should end up with something like:</p>
<pre><code class="python">import geog0111.nasa_requests as nasa_requests
from geog0111.save_data import save_data

doy,year = 273,2018
tiles = ['h17v03', 'h18v03']
destination_folder = 'data'

tile_urls = modis_tiles(doy,year,tiles)

# loop over urls
for url in tile_urls:
    r = nasa_requests.get(url)

    # check response
    if r.ok:
        # get the filename from the url
        filename = url.split('/')[-1]
        # get the binary data
        d = save_data(r.content,filename,destination_folder)
        print(filename,d)
    else:
        print (f'response from {url} not good')
</code></pre>

<pre><code>response from https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/MCD15A3H.A2018273.h17v03.006.2018278143630.hdf not good
response from https://e4ftl01.cr.usgs.gov/MOTA/MCD15A3H.006/2018.09.30/MCD15A3H.A2018273.h18v03.006.2018278143633.hdf not good
</code></pre>
<h2 id="325-visualisation">3.2.5 Visualisation</h2>
<p>We will learn more fully how to visualise these later, but just to show that the datasets exist.</p>
<p>You might want to look at the <a href="https://en.wikipedia.org/wiki/List_of_FIPS_country_codes">FIPS</a> country codes for selecting boundary data.</p>
<pre><code class="python">import requests
import shutil 
'''
Get the world borders shapefile that we will need
'''
tm_borders_url = &quot;http://thematicmapping.org/downloads/TM_WORLD_BORDERS-0.3.zip&quot;

r = requests.get(tm_borders_url)
with open(&quot;data/TM_WORLD_BORDERS-0.3.zip&quot;, 'wb') as fp:
    fp.write (r.content)

shutil.unpack_archive(&quot;data/TM_WORLD_BORDERS-0.3.zip&quot;,
                     extract_dir=&quot;data/&quot;)
</code></pre>

<pre><code>---------------------------------------------------------------------------

ReadError                                 Traceback (most recent call last)

&lt;ipython-input-20-6e327a94488d&gt; in &lt;module&gt;
     11 
     12 shutil.unpack_archive("data/TM_WORLD_BORDERS-0.3.zip",
---&gt; 13                      extract_dir="data/")


~/anaconda3/envs/geog0111/lib/python3.7/shutil.py in unpack_archive(filename, extract_dir, format)
   1000         func = _UNPACK_FORMATS[format][1]
   1001         kwargs = dict(_UNPACK_FORMATS[format][2])
-&gt; 1002         func(filename, extract_dir, **kwargs)
   1003 
   1004


~/anaconda3/envs/geog0111/lib/python3.7/shutil.py in _unpack_zipfile(filename, extract_dir)
    897 
    898     if not zipfile.is_zipfile(filename):
--&gt; 899         raise ReadError("%s is not a zip file" % filename)
    900 
    901     zip = zipfile.ZipFile(filename)


ReadError: data/TM_WORLD_BORDERS-0.3.zip is not a zip file
</code></pre>
<pre><code class="python">from geog0111.get_modis_files import get_modis_files
import gdal
import matplotlib.pylab as plt
import numpy as np

def mosaic_and_mask_data(gdal_fnames, vector_file, vector_where):
    stitch_vrt = gdal.BuildVRT(&quot;&quot;, gdal_fnames)
    g = gdal.Warp(&quot;&quot;, stitch_vrt,
                 format = 'MEM', dstNodata=200,
                  cutlineDSName = vector_file,
                  cutlineWhere = vector_where)
    return g

doy,year = 273,2018
tiles = ['h17v03', 'h18v03']
destination_folder = 'data'

filenames = get_modis_files(doy,year,tiles,base_url='https://e4ftl01.cr.usgs.gov/MOTA',\
                                           version=6,\
                                           product='MCD15A3H')

# this part is to access a particular dataset in the file
gdal_fnames = [f'HDF4_EOS:EOS_GRID:&quot;{file_name:s}&quot;:MOD_Grid_MCD15A3H:Lai_500m'
               for file_name in filenames]


g = mosaic_and_mask_data(gdal_fnames, &quot;data/TM_WORLD_BORDERS-0.3.shp&quot;,
                         &quot;FIPS='UK'&quot;)

lai = np.array(g.ReadAsArray()).astype(float) * 0.1 # for LAI scaling
# valid data mask
mask = np.nonzero(lai &lt; 20)
min_y = mask[0].min()
max_y = mask[0].max() + 1

min_x = mask[1].min()
max_x = mask[1].max() + 1

lai = lai[min_y:max_y,
               min_x:max_x]

fig = plt.figure(figsize=(12,12))
im = plt.imshow(lai, interpolation=&quot;nearest&quot;, vmin=0, vmax=6,
             cmap=plt.cm.inferno_r)
plt.title('LAI'+' '+str(tiles)+' '+str((doy,year)))
plt.colorbar()
</code></pre>

<pre><code>&lt;matplotlib.colorbar.Colorbar at 0x7f9268d39410&gt;
</code></pre>
<p><img alt="png" src="../041_MODIS_download_files/041_MODIS_download_50_1.png" /></p>
<pre><code class="python">from geog0111.get_modis_files import get_modis_files
import gdal
import matplotlib.pylab as plt
import numpy as np

def mosaic_and_mask_data(gdal_fnames, vector_file, vector_where):
    stitch_vrt = gdal.BuildVRT(&quot;&quot;, gdal_fnames)
    g = gdal.Warp(&quot;&quot;, stitch_vrt,
                 format = 'MEM', dstNodata=200,
                  cutlineDSName = vector_file,
                  cutlineWhere = vector_where)
    return g

doy,year = 273,2018
tiles = ['h17v03', 'h18v03']
destination_folder = 'data'

filenames = get_modis_files(doy,year,tiles,base_url='https://e4ftl01.cr.usgs.gov/MOTA',\
                                           version=6,\
                                           product='MCD15A3H')

# this part is to access a particular dataset in the file
gdal_fnames = [f'HDF4_EOS:EOS_GRID:&quot;{file_name:s}&quot;:MOD_Grid_MCD15A3H:Lai_500m'
               for file_name in filenames]

g = mosaic_and_mask_data(gdal_fnames, &quot;data/TM_WORLD_BORDERS-0.3.shp&quot;,
                         &quot;FIPS='NL'&quot;)

lai = np.array(g.ReadAsArray()).astype(float) * 0.1 # for LAI scaling
# valid data mask
mask = np.nonzero(lai &lt; 20)
min_y = mask[0].min()
max_y = mask[0].max() + 1

min_x = mask[1].min()
max_x = mask[1].max() + 1

lai = lai[min_y:max_y,
               min_x:max_x]

fig = plt.figure(figsize=(12,12))
im = plt.imshow(lai, interpolation=&quot;nearest&quot;, vmin=0, vmax=6,
             cmap=plt.cm.inferno_r)
plt.title('LAI'+' '+str(tiles)+' '+str((doy,year)))
plt.colorbar()
</code></pre>

<pre><code>&lt;matplotlib.colorbar.Colorbar at 0x7f92589d3bd0&gt;
</code></pre>
<p><img alt="png" src="../041_MODIS_download_files/041_MODIS_download_51_1.png" /></p>
<p><strong>Exercise 3.2.7 Homework</strong></p>
<ul>
<li>Have a look at the information for <a href="http://www.icess.ucsb.edu/modis/SnowUsrGuide/usrguide_1dtil.html"><code>MOD10A1</code> product</a>, which is the 500 m MODIS daily snow cover product.</li>
<li>Use what you have learned here to download the MOD10A product over the UK</li>
</ul>
<p><strong>Hint</strong>: 
* The data are on a different server <code>https://n5eil01u.ecs.nsidc.org/MOST</code> 
* the template for the snow cover dataxset is <code>f'HDF4_EOS:EOS_GRID:"{file_name:s}":MOD_Grid_Snow_500m:NDSI_Snow_Cover'</code>
* today-10 may not be the best example doy: choose something in winter
* valid snow cover values are 0 to 100 (use this to set <code>vmin=0, vmax=100</code> when plotting)</p>
<p><strong>N.B. You will be required to download this dataset for your assessed practical, so it is a good idea to sort code for this now</strong></p>
<pre><code class="python"># do exercise here
</code></pre>

<h2 id="326-summary">3.2.6 Summary</h2>
<p>In this session, we have learned how to download MODIS datasets from NASA Earthdata. </p>
<p>We have developed and tested functions that group together the commands we want, ultimately arriving at the function <code>get_modis_files(doy,year,tiles,**kwargs)</code>.</p>
<p>We have seen ((if you've done the homework) that such code is re-useable and can directly be used for your assessed practical.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.3636a4ec.min.js"></script>
      <script src="../assets/javascripts/bundle.e9fe3281.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>